<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>タスク状態とスケジューリング規則</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="μT-Kernel 3.0仕様書"
HREF="index.html"><LINK
REL="UP"
TITLE="μT-Kernelの概念"
HREF="concepts_underlying_utk.html"><LINK
REL="PREVIOUS"
TITLE="μT-Kernelの概念"
HREF="concepts_underlying_utk.html"><LINK
REL="NEXT"
TITLE="割込み処理"
HREF="interrupt_handling.html"></HEAD
><BODY
CLASS="section"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>μT-Kernel 3.0仕様書</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="concepts_underlying_utk.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>μT-Kernelの概念</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="interrupt_handling.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="section"
><H1
CLASS="section"
><A
NAME="task_states_and_scheduling_rules"
>タスク状態とスケジューリング規則</A
></H1
><DIV
CLASS="section"
><H2
CLASS="section"
><A
NAME="task_status"
>タスク状態</A
></H2
><P
>タスク状態は、大きく次の5つに分類される。この内、広義の待ち状態は、さらに3つの状態に分類される。また、実行状態と実行可能状態を総称して、実行できる状態と呼ぶ。</P
><P
></P
><DIV
CLASS="variablelist"
><DL
><DT
>実行状態 (RUNNING)</DT
><DD
><P
>現在そのタスクを実行中であるという状態。ただし、タスク独立部を実行している間は、別に規定されている場合を除いて、タスク独立部の実行を開始する前に実行していたタスクが実行状態であるものとする。</P
></DD
><DT
>実行可能状態 (READY)</DT
><DD
><P
>そのタスクを実行する準備は整っているが、そのタスクよりも優先順位の高いタスクが実行中であるために、そのタスクを実行できない状態。言い換えると、実行できる状態のタスクの中で最高の優先順位になればいつでも実行できる状態。</P
></DD
><DT
>広義の待ち状態</DT
><DD
><P
>そのタスクを実行できる条件が整わないために、実行ができない状態。言い換えると、何らかの条件が満たされるのを待っている状態。タスクが広義の待ち状態にある間、プログラムカウンタやレジスタなどのプログラムの実行状態を表現する情報は保存されている。タスクを広義の待ち状態から実行再開する時には、プログラムカウンタやレジスタなどを広義の待ち状態になる直前の値に戻す。広義の待ち状態は、さらに次の3つの状態に分類される。<P
></P
><DIV
CLASS="variablelist"
><DL
><DT
>待ち状態 (WAITING)</DT
><DD
><P
>何らかの条件が整うまで自タスクの実行を中断するシステムコールを呼び出したことにより、実行が中断された状態。</P
></DD
><DT
>強制待ち状態 (SUSPENDED)</DT
><DD
><P
>他のタスクによって、強制的に実行を中断させられた状態。</P
></DD
><DT
>二重待ち状態 (WAITING-SUSPENDED)</DT
><DD
><P
>待ち状態と強制待ち状態が重なった状態。待ち状態にあるタスクに対して、強制待ち状態への移行が要求されると、二重待ち状態に移行させる。</P
><P
>μT-Kernelでは「待ち状態(WAITING)」と「強制待ち状態(SUSPENDED)」を明確に区別しており、タスクが自ら強制待ち状態(SUSPENDED)になることはできない。</P
></DD
></DL
></DIV
></P
></DD
><DT
>休止状態 (DORMANT)</DT
><DD
><P
>タスクがまだ起動されていないか、実行を終了した後の状態。タスクが休止状態にある間は、実行状態を表現する情報は保存されていない。タスクを休止状態から起動する時には、タスクの起動番地から実行を開始する。また、別に規定されている場合を除いて、レジスタの内容は保証されない。</P
></DD
><DT
>未登録状態 (NON-EXISTENT)</DT
><DD
><P
>タスクがまだ生成されていないか、削除された後の、システムに登録されていない仮想的な状態。</P
></DD
></DL
></DIV
><P
>実装によっては、以上のいずれにも分類されない過渡的な状態が存在する場合がある(<A
HREF="system_states.html"
><I
>システム状態</I
>項</A
>参照)。</P
><P
>実行可能状態に移行したタスクが、現在実行中のタスクよりも高い優先順位を持つ場合には、実行可能状態への移行と同時にディスパッチが起こり、即座に実行状態へ移行する場合がある。この場合、それまで実行状態であったタスクは、新たに実行状態へ移行したタスクにプリエンプトされたという。また、システムコールの機能説明などで、「実行可能状態に移行させる」と記述されている場合でも、タスクの優先順位によっては、即座に実行状態に移行させる場合もある。</P
><P
>タスクの起動とは、休止状態のタスクを実行可能状態に移行させることをいう。このことから、休止状態と未登録状態以外の状態を総称して、起動された状態と呼ぶことがある。タスクの終了とは、起動された状態のタスクを休止状態に移行させることをいう。</P
><P
>タスクの待ち解除とは、タスクが待ち状態の時は実行可能状態に、二重待ち状態の時は強制待ち状態に移行させることをいう。また、タスクの強制待ちからの再開とは、タスクが強制待ち状態の時は実行可能状態に、二重待ち状態の時は待ち状態に移行させることをいう。</P
><P
>一般的な実装におけるタスクの状態遷移を<A
HREF="task_states_and_scheduling_rules.html#figure_task_status"
>図1</A
>に示す。実装によっては、この図にない状態遷移を行う場合がある。</P
><DIV
CLASS="figure"
><A
NAME="figure_task_status"
></A
><P
><B
>図 1. タスク状態遷移図</B
></P
><DIV
CLASS="mediaobject"
><P
><IMG
SRC="images/f_02s.png"></P
></DIV
></DIV
><P
>μT-Kernelの特色として、自タスクの操作をするシステムコールと他タスクの操作をするシステムコールを明確に分離しているということがある(<A
HREF="task_states_and_scheduling_rules.html#table_task_status"
>表1</A
>)。これは、タスクの状態遷移を明確にし、システムコールの理解を容易にするためである。自タスク操作と他タスク操作のシステムコールを分離しているということは、言い換えると、実行状態からの状態遷移とそれ以外の状態からの状態遷移を明確に分離しているという意味にもなる。</P
><DIV
CLASS="table"
><A
NAME="table_task_status"
></A
><P
><B
>表 1. 自タスク、他タスクの区別と状態遷移図</B
></P
><TABLE
BORDER="1"
FRAME="border"
RULES="all"
WIDTH="100%"
CLASS="CALSTABLE"
><COL
WIDTH="33%"
TITLE="c1"><COL
WIDTH="33%"
TITLE="c2"><COL
WIDTH="33%"
TITLE="c3"><THEAD
><TR
><TH
>&nbsp;</TH
><TH
ALIGN="center"
>&#13;                  <P
>自タスクに対する操作</P
>
                  <P
>(実行状態からの遷移)</P
>
                </TH
><TH
ALIGN="center"
>&#13;                  <P
>他タスクに対する操作</P
>
                  <P
>(実行状態以外からの遷移)</P
>
                </TH
></TR
></THEAD
><TBODY
VALIGN="top"
><TR
><TD
ALIGN="center"
VALIGN="middle"
>&#13;                  <P
>タスクの待ち状態(強制待ち状態を含む)への移行</P
>
                </TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="task_dependent_synchronization_functions.html#tk_slp_tsk"
>tk_slp_tsk</A
>
                  <P
>実行状態 → 待ち状態</P
>
                </TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="task_dependent_synchronization_functions.html#tk_sus_tsk"
>tk_sus_tsk</A
>
                  <P
>実行可能、待ち状態 → 強制待ち、二重待ち状態</P
>
                </TD
></TR
><TR
><TD
ALIGN="center"
VALIGN="middle"
>タスクの終了</TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="utk_os_functions.html#tk_ext_tsk"
>tk_ext_tsk</A
>
                  <P
>実行状態 → 休止状態</P
>
                </TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="utk_os_functions.html#tk_ter_tsk"
>tk_ter_tsk</A
>
                  <P
>実行可能、待ち状態 → 休止状態</P
>
                </TD
></TR
><TR
><TD
ALIGN="center"
VALIGN="middle"
>タスクの削除</TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="utk_os_functions.html#tk_exd_tsk"
>tk_exd_tsk</A
>
                  <P
>実行状態 → 未登録状態</P
>
                </TD
><TD
ALIGN="center"
>&#13;                  <A
HREF="utk_os_functions.html#tk_del_tsk"
>tk_del_tsk</A
>
                  <P
>休止状態 → 未登録状態</P
>
                </TD
></TR
></TBODY
></TABLE
></DIV
><DIV
CLASS="note"
><P
></P
><TABLE
CLASS="note"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.gif"
HSPACE="5"
ALT="注意"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>補足事項</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>待ち状態と強制待ち状態は直交関係にあり、強制待ち状態への移行の要求は、タスクの待ち解除条件には影響を与えない。言い換えると、タスクが待ち状態にあるか二重待ち状態にあるかで、タスクの待ち解除条件は変化しない。そのため、資源獲得のための待ち状態(セマフォ資源の獲得待ち状態やメモリブロックの獲得待ち状態など)にあるタスクに強制待ち状態への移行が要求され、二重待ち状態になった場合にも、強制待ち状態への移行が要求されなかった場合と同じ条件で資源の割付け(セマフォ資源やメモリブロックの割付けなど)が行われる。</P
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="note"
><P
></P
><TABLE
CLASS="note"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.gif"
HSPACE="5"
ALT="注意"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>仕様決定の理由</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>μT-Kernelにおいて待ち状態(自タスクによる待ち)と強制待ち状態(他のタスクによる待ち)を区別しているのは、それらが重なる場合があるためである。それらが重なった状態を二重待ち状態として区別することで、タスクの状態遷移が明確になり、システムコールの理解が容易になる。それに対して、待ち状態のタスクはシステムコールを呼び出せないため、複数の種類の待ち状態(例えば、起床待ち状態とセマフォ資源の獲得待ち状態)が重なることはない。μT-Kernelでは、他のタスクによる待ちには一つの種類(強制待ち状態)しかないため、強制待ち状態が重なった状況を強制待ち要求のネストと扱うことで、タスクの状態遷移を明確にしている。</P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="section"
><H2
CLASS="section"
><A
NAME="task_scheduling"
>タスクのスケジューリング規則</A
></H2
><P
>μT-Kernelにおいては、タスクに与えられた優先度に基づくプリエンプティブな優先度ベーススケジューリング方式を採用している。同じ優先度を持つタスク間では、FCFS(First Come First Served)方式によりスケジューリングを行う。具体的には、タスクのスケジューリング規則はタスク間の優先順位を用いて、タスク間の優先順位はタスクの優先度によって、それぞれ次のように規定される。実行できるタスクが複数ある場合には、その中で最も優先順位の高いタスクが実行状態となり、他は実行可能状態となる。タスク間の優先順位は、異なる優先度を持つタスク間では、高い優先度を持つタスクの方が高い優先順位を持つ。同じ優先度を持つタスク間では、先に実行できる状態(実行状態または実行可能状態)になったタスクの方が高い優先順位を持つ。ただし、システムコールの呼出により、同じ優先度を持つタスク間の優先順位が変更される場合がある。</P
><P
>最も高い優先順位を持つタスクが替わった場合には、ただちにディスパッチが起こり、実行状態のタスクが切り替わる。ただし、ディスパッチが起こらない状態(ハンドラ実行中やディスパッチ禁止状態など)になっている場合には、実行状態のタスクの切替えは、ディスパッチが起こる状態となるまで保留される。</P
><DIV
CLASS="note"
><P
></P
><TABLE
CLASS="note"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.gif"
HSPACE="5"
ALT="注意"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>補足事項</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>μT-Kernelのスケジューリング規則では、優先順位の高いタスクが実行できる状態にある限り、それより優先順位の低いタスクは全く実行されない。すなわち、最も高い優先順位を持つタスクが待ち状態に入るなどの理由で実行できない状態とならない限り、他のタスクは全く実行されない。この点で、複数のタスクを公平に実行しようというTSS(Time Sharing System)のスケジューリング方式とは根本的に異なっている。</P
><P
>ただし、同じ優先度を持つタスク間の優先順位は、システムコールを用いて変更することが可能である。アプリケーションがそのようなシステムコールを用いて、TSSにおける代表的なスケジューリング方式であるラウンドロビン方式を実現することができる。</P
><P
>同じ優先度を持つタスク間では、先に実行できる状態(実行状態または実行可能状態)になったタスクの方が高い優先順位を持つことを、図の例を用いて説明する。<A
HREF="task_states_and_scheduling_rules.html#figure_a_task_scheduling"
>図2</A
>は、優先度1のタスクA、優先度3のタスクE、優先度2のタスクB、タスクC、タスクDがこの順序で起動された後のタスク間の優先順位を示す。この状態では、最も優先順位の高いタスクAが実行状態となっている。</P
><P
>ここでタスクAが終了すると、次に優先順位の高いタスクBを実行状態に遷移させる(<A
HREF="task_states_and_scheduling_rules.html#figure_b_task_scheduling"
>図3</A
>)。その後タスク Aが再び起動されると、タスクBはプリエンプトされて実行可能状態に戻るが、この時タスクBは、タスクCとタスクDのいずれよりも先に実行できる状態になっていたことから、同じ優先度を持つタスクの中で最高の優先順位を持つことになる。すなわち、タスク間の優先順位は<A
HREF="task_states_and_scheduling_rules.html#figure_a_task_scheduling"
>図2</A
>の状態に戻る。</P
><P
>次に、<A
HREF="task_states_and_scheduling_rules.html#figure_b_task_scheduling"
>図3</A
>の状態でタスクBが待ち状態になった場合を考える。タスクの優先順位は実行できるタスクの間で定義されるため、タスク間の優先順位は<A
HREF="task_states_and_scheduling_rules.html#figure_c_task_scheduling"
>図4</A
>の状態となる。その後タスクBが待ち解除されると、タスクBはタスクCとタスクDのいずれよりも後に実行できる状態になったことから、同じ優先度を持つタスクの中で最低の優先順位となる(<A
HREF="task_states_and_scheduling_rules.html#figure_d_task_scheduling"
>図5</A
>)。</P
><P
>以上を整理すると、実行可能状態のタスクが実行状態になった後に実行可能状態に戻った直後には、同じ優先度を持つタスクの中で最高の優先順位を持っているのに対して、実行状態のタスクが待ち状態になった後に待ち解除されて実行できる状態になった直後には、同じ優先度を持つタスクの中で最低の優先順位となる。</P
><P
>なお、タスクが強制待ち状態(SUSPENDED)から実行できる状態になった直後にも、同じ優先度を持つタスクの中で最低の優先順位となる。</P
><DIV
CLASS="figure"
><A
NAME="figure_a_task_scheduling"
></A
><P
><B
>図 2. 最初の状態の優先順位</B
></P
><DIV
CLASS="mediaobject"
><P
><IMG
SRC="images/f_03_as.png"></P
></DIV
></DIV
><DIV
CLASS="figure"
><A
NAME="figure_b_task_scheduling"
></A
><P
><B
>図 3. タスクBが実行状態になった後の優先順位</B
></P
><DIV
CLASS="mediaobject"
><P
><IMG
SRC="images/f_03_bs.png"></P
></DIV
></DIV
><DIV
CLASS="figure"
><A
NAME="figure_c_task_scheduling"
></A
><P
><B
>図 4. タスクBが待ち状態になった後の優先順位</B
></P
><DIV
CLASS="mediaobject"
><P
><IMG
SRC="images/f_03_cs.png"></P
></DIV
></DIV
><DIV
CLASS="figure"
><A
NAME="figure_d_task_scheduling"
></A
><P
><B
>図 5. タスクBが待ち解除された後の優先順位</B
></P
><DIV
CLASS="mediaobject"
><P
><IMG
SRC="images/f_03_ds.png"></P
></DIV
></DIV
></TD
></TR
></TABLE
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="concepts_underlying_utk.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="interrupt_handling.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>μT-Kernelの概念</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="concepts_underlying_utk.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>割込み処理</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>